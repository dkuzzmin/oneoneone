<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Crystal Maze</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
            margin: 0 auto;
            border: 2px solid #fff;
            border-radius: 10px;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            text-align: center;
            font-size: 14px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        #winMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,255,0,0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 24px;
            text-align: center;
            display: none;
            z-index: 200;
        }
        
        #avatarSelection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #avatarSelection h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 1000px;
            padding: 20px;
        }
        
        .avatar-card {
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            color: white;
            text-align: center;
        }
        
        .avatar-card:hover {
            border-color: #3498db;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(52,152,219,0.3);
        }
        
        .avatar-card.selected {
            border-color: #e74c3c;
            background: rgba(231,76,60,0.2);
        }
        
        .avatar-emoji {
            font-size: 4em;
            margin-bottom: 15px;
            display: block;
        }
        
        .avatar-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .avatar-description {
            font-size: 0.9em;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .start-button {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 1.2em;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .start-button.enabled {
            opacity: 1;
            pointer-events: auto;
        }
        
        .start-button:hover.enabled {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231,76,60,0.4);
        }
    </style>
</head>
<body>
    <div id="avatarSelection">
        <h1>Choose Your Character</h1>
        <div class="avatar-grid">
            <div class="avatar-card" data-avatar="0">
                <span class="avatar-emoji">üê∫</span>
                <div class="avatar-name">Lone Wolf</div>
                <div class="avatar-description">Dark cloak, hidden face, cold gaze</div>
            </div>
            <div class="avatar-card" data-avatar="1">
                <span class="avatar-emoji">üéí</span>
                <div class="avatar-name">Adventure Seeker</div>
                <div class="avatar-description">Bright jacket, backpack, compass on belt</div>
            </div>
            <div class="avatar-card" data-avatar="2">
                <span class="avatar-emoji">‚öîÔ∏è</span>
                <div class="avatar-name">Strategist</div>
                <div class="avatar-description">Strict suit or armor, holds map or scroll</div>
            </div>
            <div class="avatar-card" data-avatar="3">
                <span class="avatar-emoji">üßô‚Äç‚ôÇÔ∏è</span>
                <div class="avatar-name">Wise Keeper</div>
                <div class="avatar-description">Gray hair, long robe, staff or book</div>
            </div>
            <div class="avatar-card" data-avatar="4">
                <span class="avatar-emoji">üé®</span>
                <div class="avatar-name">Cheerful Creator</div>
                <div class="avatar-description">Colorful clothes, brushes, musical instrument</div>
            </div>
        </div>
        <button class="start-button" id="startButton" onclick="startGame()">Start Game</button>
    </div>

    <div id="ui" style="display: none;">
        <div>Crystals Collected: <span id="score">0</span>/5</div>
        <div>Time: <span id="time">0</span>s</div>
        <div>Character: <span id="currentAvatar"></span></div>
    </div>
    
    <div id="controls" style="display: none;">
        Controls: WASD or Arrow Keys to move | Mouse to rotate camera
    </div>
    
    <div id="winMessage">
        <h2>üéâ Congratulations! üéâ</h2>
        <p>You collected all crystals!</p>
        <p>Time: <span id="finalTime"></span>s</p>
        <button onclick="restartGame()">Play Again</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Global variables
        let scene, camera, renderer, player, crystals = [], walls = [];
        let moveState = { forward: false, backward: false, left: false, right: false };
        let score = 0;
        let startTime = Date.now();
        let gameWon = false;
        let selectedAvatar = null;
        let gameStarted = false;
        
        // Avatar data
        const avatars = [
            { name: "Lone Wolf", color: 0x2c3e50, emoji: "üê∫" },
            { name: "Adventure Seeker", color: 0xe67e22, emoji: "üéí" },
            { name: "Strategist", color: 0x8e44ad, emoji: "‚öîÔ∏è" },
            { name: "Wise Keeper", color: 0x27ae60, emoji: "üßô‚Äç‚ôÇÔ∏è" },
            { name: "Cheerful Creator", color: 0xe74c3c, emoji: "üé®" }
        ];
        
        // Avatar selection handling
        document.addEventListener('DOMContentLoaded', function() {
            const avatarCards = document.querySelectorAll('.avatar-card');
            const startButton = document.getElementById('startButton');
            
            avatarCards.forEach(card => {
                card.addEventListener('click', function() {
                    // Remove selection from other cards
                    avatarCards.forEach(c => c.classList.remove('selected'));
                    
                    // Select clicked card
                    this.classList.add('selected');
                    
                    // Save selected avatar
                    selectedAvatar = parseInt(this.dataset.avatar);
                    
                    // Enable start button
                    startButton.classList.add('enabled');
                });
            });
        });
        
        function startGame() {
            if (selectedAvatar === null) return;
            
            // Hide avatar selection screen
            document.getElementById('avatarSelection').style.display = 'none';
            
            // Show game interface
            document.getElementById('ui').style.display = 'block';
            document.getElementById('controls').style.display = 'block';
            
            // Update character info
            document.getElementById('currentAvatar').textContent = avatars[selectedAvatar].name + ' ' + avatars[selectedAvatar].emoji;
            
            gameStarted = true;
            initGame();
        }
        
        // Scene setup
        function initGame() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Create maze
            createMaze();
            createPlayer();
            createCrystals();
            
            // Event handlers
            setupControls();
            
            // Start game loop
            animate();
        }
        
        function createMaze() {
            // Floor
            const floorGeometry = new THREE.PlaneGeometry(50, 50);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Maze walls
            const wallPositions = [
                // Outer walls
                [-25, 0], [25, 0], [0, -25], [0, 25],
                // Inner walls
                [-15, -10], [-15, 10], [15, -10], [15, 10],
                [-5, -15], [-5, 15], [5, -15], [5, 15],
                [-10, 0], [10, 0], [0, -10], [0, 10]
            ];
            
            wallPositions.forEach(pos => {
                createWall(pos[0], pos[1]);
            });
        }
        
        function createWall(x, z) {
            const wallGeometry = new THREE.BoxGeometry(2, 4, 2);
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const wall = new THREE.Mesh(wallGeometry, wallMaterial);
            wall.position.set(x, 2, z);
            wall.castShadow = true;
            wall.receiveShadow = true;
            walls.push(wall);
            scene.add(wall);
        }
        
        function createPlayer() {
            const playerGeometry = new THREE.BoxGeometry(1, 1, 1);
            const playerMaterial = new THREE.MeshLambertMaterial({ 
                color: selectedAvatar !== null ? avatars[selectedAvatar].color : 0x4169E1 
            });
            player = new THREE.Mesh(playerGeometry, playerMaterial);
            player.position.set(-20, 0.5, -20);
            player.castShadow = true;
            scene.add(player);
            
            // Camera follows player
            camera.position.set(-20, 5, -15);
            camera.lookAt(player.position);
        }
        
        function createCrystals() {
            const crystalPositions = [
                [18, 18], [-18, 18], [18, -18], [-18, -18], [0, 0]
            ];
            
            crystalPositions.forEach(pos => {
                const crystalGeometry = new THREE.OctahedronGeometry(0.8);
                const crystalMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0xFF69B4,
                    transparent: true,
                    opacity: 0.8
                });
                const crystal = new THREE.Mesh(crystalGeometry, crystalMaterial);
                crystal.position.set(pos[0], 1.5, pos[1]);
                crystal.castShadow = true;
                crystals.push(crystal);
                scene.add(crystal);
            });
        }
        
        function setupControls() {
            document.addEventListener('keydown', (event) => {
                switch(event.code) {
                    case 'KeyW':
                    case 'ArrowUp':
                        moveState.forward = true;
                        break;
                    case 'KeyS':
                    case 'ArrowDown':
                        moveState.backward = true;
                        break;
                    case 'KeyA':
                    case 'ArrowLeft':
                        moveState.left = true;
                        break;
                    case 'KeyD':
                    case 'ArrowRight':
                        moveState.right = true;
                        break;
                }
            });
            
            document.addEventListener('keyup', (event) => {
                switch(event.code) {
                    case 'KeyW':
                    case 'ArrowUp':
                        moveState.forward = false;
                        break;
                    case 'KeyS':
                    case 'ArrowDown':
                        moveState.backward = false;
                        break;
                    case 'KeyA':
                    case 'ArrowLeft':
                        moveState.left = false;
                        break;
                    case 'KeyD':
                    case 'ArrowRight':
                        moveState.right = false;
                        break;
                }
            });
            
            // Mouse controls for camera rotation
            let mouseX = 0, mouseY = 0;
            let isMouseDown = false;
            
            document.addEventListener('mousedown', () => isMouseDown = true);
            document.addEventListener('mouseup', () => isMouseDown = false);
            document.addEventListener('mousemove', (event) => {
                if (isMouseDown) {
                    mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                    mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
                }
            });
        }
        
        function updatePlayer() {
            if (gameWon) return;
            
            const speed = 0.15;
            const newPosition = player.position.clone();
            
            if (moveState.forward) newPosition.z -= speed;
            if (moveState.backward) newPosition.z += speed;
            if (moveState.left) newPosition.x -= speed;
            if (moveState.right) newPosition.x += speed;
            
            // Wall collision detection
            let collision = false;
            walls.forEach(wall => {
                const distance = newPosition.distanceTo(wall.position);
                if (distance < 2) {
                    collision = true;
                }
            });
            
            // Map boundaries
            if (newPosition.x > 24 || newPosition.x < -24 || 
                newPosition.z > 24 || newPosition.z < -24) {
                collision = true;
            }
            
            if (!collision) {
                player.position.copy(newPosition);
                
                // Update camera position
                camera.position.x = player.position.x;
                camera.position.z = player.position.z + 5;
                camera.lookAt(player.position);
            }
            
            // Player rotation
            player.rotation.y += 0.02;
        }
        
        function checkCrystalCollection() {
            crystals.forEach((crystal, index) => {
                if (crystal.visible) {
                    const distance = player.position.distanceTo(crystal.position);
                    if (distance < 2) {
                        crystal.visible = false;
                        score++;
                        document.getElementById('score').textContent = score;
                        
                        if (score >= 5) {
                            winGame();
                        }
                    }
                }
            });
        }
        
        function updateCrystals() {
            crystals.forEach(crystal => {
                if (crystal.visible) {
                    crystal.rotation.y += 0.05;
                    crystal.position.y = 1.5 + Math.sin(Date.now() * 0.002) * 0.3;
                }
            });
        }
        
        function updateUI() {
            if (!gameWon) {
                const currentTime = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('time').textContent = currentTime;
            }
        }
        
        function winGame() {
            gameWon = true;
            const finalTime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('finalTime').textContent = finalTime;
            document.getElementById('winMessage').style.display = 'block';
        }
        
        function restartGame() {
            // Reset game
            score = 0;
            gameWon = false;
            startTime = Date.now();
            
            document.getElementById('score').textContent = '0';
            document.getElementById('time').textContent = '0';
            document.getElementById('winMessage').style.display = 'none';
            
            // Show avatar selection screen again
            document.getElementById('avatarSelection').style.display = 'flex';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            
            // Reset avatar selection
            selectedAvatar = null;
            gameStarted = false;
            document.querySelectorAll('.avatar-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('startButton').classList.remove('enabled');
            
            // Clear scene if it exists
            if (scene) {
                while(scene.children.length > 0) {
                    scene.remove(scene.children[0]);
                }
                if (renderer && renderer.domElement && renderer.domElement.parentNode) {
                    renderer.domElement.parentNode.removeChild(renderer.domElement);
                }
            }
            
            // Reset arrays
            crystals = [];
            walls = [];
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            updatePlayer();
            checkCrystalCollection();
            updateCrystals();
            updateUI();
            
            renderer.render(scene, camera);
        }
        
        // Window resize handler
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
        
        // Don't start game automatically - wait for avatar selection
        // initGame(); - removed
    </script>
</body>
</html>
